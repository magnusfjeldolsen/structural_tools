{"version":3,"file":"solverWorker-2qW0q_iS.js","sources":["../public/workers/solverWorker.js"],"sourcesContent":["/**\n * PyNite Analysis Worker\n * Lightweight JavaScript worker that loads Pyodide and Python modules\n *\n * Architecture:\n * 1. Load Pyodide runtime\n * 2. Install dependencies (numpy, scipy, etc.)\n * 3. Setup package mocking (for PyNite compatibility)\n * 4. Install PyNite\n * 5. Load Python analysis modules from /python/ directory\n * 6. Handle analysis requests via message passing\n */\n\n// Load Pyodide from CDN - v0.29.1 has NumPy 2.2.5 (compatible with PyNite 2.0.0)\nimportScripts(\"https://cdn.jsdelivr.net/pyodide/v0.29.1/full/pyodide.js\");\n\nlet pyodide = null;\nlet isInitialized = false;\n\n/**\n * Initialize Pyodide environment\n * This runs once when worker receives 'init' message\n */\nasync function initializePyodide() {\n    if (isInitialized) {\n        console.log(\"[Worker] Already initialized, skipping\");\n        return;\n    }\n\n    try {\n        console.log(\"[Worker] Loading Pyodide runtime...\");\n        pyodide = await loadPyodide();\n\n        console.log(\"[Worker] Installing core dependencies...\");\n        await pyodide.loadPackage([\"numpy\", \"micropip\"]);\n\n        console.log(\"[Worker] Installing additional dependencies via micropip...\");\n        await pyodide.runPythonAsync(`\n            import micropip\n            await micropip.install(\"scipy\")\n            await micropip.install(\"matplotlib\")\n            # prettytable not needed for core PyNite functionality\n        `);\n\n        console.log(\"[Worker] Setting up package mocking for PyNite...\");\n        // Fetch and run the package mocking setup\n        // Use self.location to construct path (classic workers don't support import.meta)\n        const workerDir = self.location.pathname.substring(0, self.location.pathname.lastIndexOf('/'));\n        const setupPath = workerDir + '/../python/setup_pynite_env.py';\n        const setupResponse = await fetch(setupPath);\n        if (!setupResponse.ok) {\n            throw new Error(`Failed to fetch setup_pynite_env.py: ${setupResponse.status} (path: ${setupPath})`);\n        }\n        const setupCode = await setupResponse.text();\n        await pyodide.runPythonAsync(setupCode);\n        await pyodide.runPythonAsync('setup_package_mocking()');\n\n        console.log(\"[Worker] Installing PyNite...\");\n        await pyodide.runPythonAsync(`\n            import micropip\n            # Install PyNite 2.0.0 - last version before numpy 2.4+ requirement (v2.0.3+)\n            await micropip.install(\"PyniteFEA==2.0.0\")\n        `);\n\n        console.log(\"[Worker] Loading PyNite analyzer module...\");\n        // Fetch and load the main analysis module\n        const analyzerPath = workerDir + '/../python/pynite_analyzer.py';\n        const analyzerResponse = await fetch(analyzerPath);\n        if (!analyzerResponse.ok) {\n            throw new Error(`Failed to fetch pynite_analyzer.py: ${analyzerResponse.status} (path: ${analyzerPath})`);\n        }\n        const analyzerCode = await analyzerResponse.text();\n        await pyodide.runPythonAsync(analyzerCode);\n\n        console.log(\"[Worker] Running self-test...\");\n        // Test that the analyzer works\n        const testResult = await pyodide.runPythonAsync(`\n            import json\n            test_data = {\n                'nodes': [\n                    {'name': 'N1', 'x': 0, 'y': 0, 'support': 'fixed'},\n                    {'name': 'N2', 'x': 4, 'y': 0, 'support': 'free'}\n                ],\n                'elements': [\n                    {'name': 'E1', 'nodeI': 'N1', 'nodeJ': 'N2', 'E': 210, 'I': 1e-4, 'A': 1e-3}\n                ],\n                'loads': {\n                    'nodal': [{'node': 'N2', 'fx': 0, 'fy': -10, 'mz': 0}],\n                    'distributed': [],\n                    'elementPoint': []\n                }\n            }\n            result = analyze_frame_json(json.dumps(test_data))\n            json.loads(result).get('success', False)\n        `);\n\n        if (!testResult) {\n            throw new Error(\"Self-test failed - analyzer did not return success\");\n        }\n\n        console.log(\"[Worker] âœ“ Initialization complete!\");\n        isInitialized = true;\n\n    } catch (error) {\n        console.error(\"[Worker] Initialization failed:\", error);\n        throw error;\n    }\n}\n\n/**\n * Run analysis using loaded Python functions\n *\n * @param {Object} modelData - Frame model data\n * @param {string} analysisType - 'simple' | 'loadCase' | 'combination'\n * @param {string|Object} targetName - Load case name or combination object\n * @returns {Object} Analysis results\n */\nasync function runAnalysis(modelData, analysisType, targetName) {\n    if (!pyodide || !isInitialized) {\n        throw new Error(\"Pyodide not initialized. Send 'init' message first.\");\n    }\n\n    const modelJson = JSON.stringify(modelData).replace(/'/g, \"\\\\'\");\n\n    let pythonCode;\n    if (analysisType === 'loadCase') {\n        pythonCode = `analyze_frame_single_case('${modelJson}', '${targetName}')`;\n    } else if (analysisType === 'combination') {\n        const comboJson = JSON.stringify(targetName).replace(/'/g, \"\\\\'\");\n        pythonCode = `analyze_frame_combination('${modelJson}', '${comboJson}')`;\n    } else {\n        // Simple analysis (all loads combined)\n        pythonCode = `analyze_frame_json('${modelJson}')`;\n    }\n\n    const resultJson = await pyodide.runPythonAsync(pythonCode);\n    return JSON.parse(resultJson);\n}\n\n/**\n * Message handler - listens for commands from main thread\n *\n * Message format:\n * {\n *   type: 'init' | 'analyze',\n *   payload: { modelData, analysisType, targetName },\n *   msgId: 'unique-id'\n * }\n */\nself.onmessage = async (e) => {\n    const { type, payload, msgId } = e.data;\n\n    try {\n        switch(type) {\n            case 'init':\n                console.log(\"[Worker] Received init request\");\n                await initializePyodide();\n                self.postMessage({ type: 'ready', msgId });\n                break;\n\n            case 'analyze':\n                console.log(\"[Worker] Received analysis request\");\n                const { modelData, analysisType, targetName } = payload;\n                const result = await runAnalysis(modelData, analysisType || 'simple', targetName);\n                self.postMessage({ type: 'results', payload: result, msgId });\n                break;\n\n            case 'ping':\n                // Health check\n                self.postMessage({\n                    type: 'pong',\n                    payload: { initialized: isInitialized },\n                    msgId\n                });\n                break;\n\n            default:\n                throw new Error(`Unknown message type: ${type}`);\n        }\n    } catch (error) {\n        console.error(\"[Worker] Error:\", error);\n        self.postMessage({\n            type: 'error',\n            payload: {\n                message: error.message,\n                stack: error.stack,\n                phase: isInitialized ? 'analysis' : 'initialization'\n            },\n            msgId\n        });\n    }\n};\n\n// Log when worker starts\nconsole.log(\"[Worker] PyNite Solver Worker loaded and ready\");\n"],"names":["pyodide","isInitialized","initializePyodide","workerDir","setupPath","setupResponse","setupCode","analyzerPath","analyzerResponse","analyzerCode","error","runAnalysis","modelData","analysisType","targetName","modelJson","pythonCode","comboJson","resultJson","e","type","payload","msgId","result"],"mappings":"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"}