{"version":3,"file":"solverWorker-9UwxVH1f.js","sources":["../public/workers/solverWorker.js"],"sourcesContent":["/**\r\n * PyNite Analysis Worker\r\n * Lightweight JavaScript worker that loads Pyodide and Python modules\r\n *\r\n * Architecture:\r\n * 1. Load Pyodide runtime\r\n * 2. Install dependencies (numpy, scipy, etc.)\r\n * 3. Setup package mocking (for PyNite compatibility)\r\n * 4. Install PyNite\r\n * 5. Load Python analysis modules from /python/ directory\r\n * 6. Handle analysis requests via message passing\r\n */\r\n\r\n// Load Pyodide from CDN\r\nimportScripts(\"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js\");\r\n\r\nlet pyodide = null;\r\nlet isInitialized = false;\r\n\r\n/**\r\n * Initialize Pyodide environment\r\n * This runs once when worker receives 'init' message\r\n */\r\nasync function initializePyodide() {\r\n    if (isInitialized) {\r\n        console.log(\"[Worker] Already initialized, skipping\");\r\n        return;\r\n    }\r\n\r\n    try {\r\n        console.log(\"[Worker] Loading Pyodide runtime...\");\r\n        pyodide = await loadPyodide();\r\n\r\n        console.log(\"[Worker] Installing core dependencies...\");\r\n        await pyodide.loadPackage([\"numpy\", \"micropip\"]);\r\n\r\n        console.log(\"[Worker] Installing additional dependencies via micropip...\");\r\n        await pyodide.runPythonAsync(`\r\n            import micropip\r\n            await micropip.install(\"prettytable\")\r\n            await micropip.install(\"scipy\")\r\n            await micropip.install(\"matplotlib\")\r\n        `);\r\n\r\n        console.log(\"[Worker] Setting up package mocking for PyNite...\");\r\n        // Fetch and run the package mocking setup\r\n        const setupResponse = await fetch('/public/python/setup_pynite_env.py');\r\n        if (!setupResponse.ok) {\r\n            throw new Error(`Failed to fetch setup_pynite_env.py: ${setupResponse.status}`);\r\n        }\r\n        const setupCode = await setupResponse.text();\r\n        await pyodide.runPythonAsync(setupCode);\r\n        await pyodide.runPythonAsync('setup_package_mocking()');\r\n\r\n        console.log(\"[Worker] Installing PyNite...\");\r\n        await pyodide.runPythonAsync(`\r\n            import micropip\r\n            await micropip.install(\"PyniteFEA\")\r\n        `);\r\n\r\n        console.log(\"[Worker] Loading PyNite analyzer module...\");\r\n        // Fetch and load the main analysis module\r\n        const analyzerResponse = await fetch('/public/python/pynite_analyzer.py');\r\n        if (!analyzerResponse.ok) {\r\n            throw new Error(`Failed to fetch pynite_analyzer.py: ${analyzerResponse.status}`);\r\n        }\r\n        const analyzerCode = await analyzerResponse.text();\r\n        await pyodide.runPythonAsync(analyzerCode);\r\n\r\n        console.log(\"[Worker] Running self-test...\");\r\n        // Test that the analyzer works\r\n        const testResult = await pyodide.runPythonAsync(`\r\n            import json\r\n            test_data = {\r\n                'nodes': [\r\n                    {'name': 'N1', 'x': 0, 'y': 0, 'support': 'fixed'},\r\n                    {'name': 'N2', 'x': 4, 'y': 0, 'support': 'free'}\r\n                ],\r\n                'elements': [\r\n                    {'name': 'E1', 'nodeI': 'N1', 'nodeJ': 'N2', 'E': 210, 'I': 1e-4, 'A': 1e-3}\r\n                ],\r\n                'loads': {\r\n                    'nodal': [{'node': 'N2', 'fx': 0, 'fy': -10, 'mz': 0}],\r\n                    'distributed': [],\r\n                    'elementPoint': []\r\n                }\r\n            }\r\n            result = analyze_frame_json(json.dumps(test_data))\r\n            json.loads(result).get('success', False)\r\n        `);\r\n\r\n        if (!testResult) {\r\n            throw new Error(\"Self-test failed - analyzer did not return success\");\r\n        }\r\n\r\n        console.log(\"[Worker] âœ“ Initialization complete!\");\r\n        isInitialized = true;\r\n\r\n    } catch (error) {\r\n        console.error(\"[Worker] Initialization failed:\", error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Run analysis using loaded Python functions\r\n *\r\n * @param {Object} modelData - Frame model data\r\n * @param {string} analysisType - 'simple' | 'loadCase' | 'combination'\r\n * @param {string|Object} targetName - Load case name or combination object\r\n * @returns {Object} Analysis results\r\n */\r\nasync function runAnalysis(modelData, analysisType, targetName) {\r\n    if (!pyodide || !isInitialized) {\r\n        throw new Error(\"Pyodide not initialized. Send 'init' message first.\");\r\n    }\r\n\r\n    const modelJson = JSON.stringify(modelData).replace(/'/g, \"\\\\'\");\r\n\r\n    let pythonCode;\r\n    if (analysisType === 'loadCase') {\r\n        pythonCode = `analyze_frame_single_case('${modelJson}', '${targetName}')`;\r\n    } else if (analysisType === 'combination') {\r\n        const comboJson = JSON.stringify(targetName).replace(/'/g, \"\\\\'\");\r\n        pythonCode = `analyze_frame_combination('${modelJson}', '${comboJson}')`;\r\n    } else {\r\n        // Simple analysis (all loads combined)\r\n        pythonCode = `analyze_frame_json('${modelJson}')`;\r\n    }\r\n\r\n    const resultJson = await pyodide.runPythonAsync(pythonCode);\r\n    return JSON.parse(resultJson);\r\n}\r\n\r\n/**\r\n * Message handler - listens for commands from main thread\r\n *\r\n * Message format:\r\n * {\r\n *   type: 'init' | 'analyze',\r\n *   payload: { modelData, analysisType, targetName },\r\n *   msgId: 'unique-id'\r\n * }\r\n */\r\nself.onmessage = async (e) => {\r\n    const { type, payload, msgId } = e.data;\r\n\r\n    try {\r\n        switch(type) {\r\n            case 'init':\r\n                console.log(\"[Worker] Received init request\");\r\n                await initializePyodide();\r\n                self.postMessage({ type: 'ready', msgId });\r\n                break;\r\n\r\n            case 'analyze':\r\n                console.log(\"[Worker] Received analysis request\");\r\n                const { modelData, analysisType, targetName } = payload;\r\n                const result = await runAnalysis(modelData, analysisType || 'simple', targetName);\r\n                self.postMessage({ type: 'results', payload: result, msgId });\r\n                break;\r\n\r\n            case 'ping':\r\n                // Health check\r\n                self.postMessage({\r\n                    type: 'pong',\r\n                    payload: { initialized: isInitialized },\r\n                    msgId\r\n                });\r\n                break;\r\n\r\n            default:\r\n                throw new Error(`Unknown message type: ${type}`);\r\n        }\r\n    } catch (error) {\r\n        console.error(\"[Worker] Error:\", error);\r\n        self.postMessage({\r\n            type: 'error',\r\n            payload: {\r\n                message: error.message,\r\n                stack: error.stack,\r\n                phase: isInitialized ? 'analysis' : 'initialization'\r\n            },\r\n            msgId\r\n        });\r\n    }\r\n};\r\n\r\n// Log when worker starts\r\nconsole.log(\"[Worker] PyNite Solver Worker loaded and ready\");\r\n"],"names":["pyodide","isInitialized","initializePyodide","setupResponse","setupCode","analyzerResponse","analyzerCode","error","runAnalysis","modelData","analysisType","targetName","modelJson","pythonCode","comboJson","resultJson","e","type","payload","msgId","result"],"mappings":"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"}