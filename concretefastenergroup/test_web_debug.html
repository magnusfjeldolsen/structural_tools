<!DOCTYPE html>
<html>
<head>
    <title>Debug Web Interface</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
    <h1>Debug: Web Interface with Mx=10kNm</h1>
    <button onclick="runTest()">Run Test</button>
    <pre id="output"></pre>
    <pre id="debug" style="color: blue;"></pre>

    <script>
        let pyodide;

        async function loadPyodide() {
            const output = document.getElementById('output');
            output.textContent = 'Loading Pyodide...\n';

            pyodide = await window.loadPyodide();
            await pyodide.loadPackage(['numpy']);

            output.textContent += 'Pyodide loaded!\n';

            // Redirect stderr to capture debug output
            pyodide.runPython(`
import sys
import io

class DebugCapture:
    def __init__(self):
        self.output = []
    def write(self, text):
        self.output.append(text)
    def flush(self):
        pass

debug_capture = DebugCapture()
sys.stderr = debug_capture
            `);
        }

        async function runTest() {
            const output = document.getElementById('output');
            const debugDiv = document.getElementById('debug');

            if (!pyodide) {
                await loadPyodide();
            }

            output.textContent = 'Running test...\n';

            try {
                // Load Python modules
                const files = [
                    'codes/python/fastener_design/__init__.py',
                    'codes/python/fastener_design/web_interface.py',
                    'codes/python/fastener_design/design.py',
                    'codes/python/fastener_design/calculations/__init__.py',
                    'codes/python/fastener_design/calculations/planar_bending.py',
                    'codes/python/fastener_design/core/__init__.py',
                    'codes/python/fastener_design/core/fastener.py',
                    'codes/python/fastener_design/core/fastener_group.py',
                    'codes/python/fastener_design/core/concrete.py',
                    'codes/python/fastener_design/core/factors.py'
                ];

                for (const file of files) {
                    const response = await fetch(file);
                    const content = await response.text();
                    pyodide.FS.writeFile('/' + file, content);
                }

                // Run analysis
                const input = {
                    "fasteners": [
                        {"id": 1, "x": 0, "y": 0, "diameter": 16, "embedment_depth": 100, "steel_grade": 500},
                        {"id": 2, "x": 100, "y": 0, "diameter": 16, "embedment_depth": 100, "steel_grade": 500},
                        {"id": 3, "x": 100, "y": 100, "diameter": 16, "embedment_depth": 100, "steel_grade": 500},
                        {"id": 4, "x": 0, "y": 100, "diameter": 16, "embedment_depth": 100, "steel_grade": 500}
                    ],
                    "concrete": {"fck": 30, "h": 200},
                    "loading": {
                        "load_cases": [{
                            "name": "LC1",
                            "description": "Mx test",
                            "Vx": 0,
                            "Vy": 0,
                            "Mx": 10.0,
                            "My": 0,
                            "Mz": 0,
                            "N": 0,
                            "application_type": "centroid"
                        }]
                    },
                    "edge_distances": {"c1": 150, "c2": 150},
                    "spacings": {"auto_calculate": true},
                    "analysis_options": {
                        "loading_type": "static",
                        "failure_modes": {"tension": ["steel"], "shear": []},
                        "interaction_exponents": {"alpha_N": 1.5, "beta_V": 1.5}
                    }
                };

                const result = await pyodide.runPythonAsync(`
import sys
sys.path.insert(0, '/codes/python')
import json
from fastener_design.web_interface import run_analysis

input_json = '''${JSON.stringify(input)}'''
result_json = run_analysis(input_json)
result = json.loads(result_json)

# Get debug output
debug_output = '\\n'.join(debug_capture.output)

json.dumps({
    'result': result,
    'debug': debug_output
}, indent=2)
                `);

                const data = JSON.parse(result);

                // Show debug output
                debugDiv.textContent = 'DEBUG OUTPUT:\n' + data.debug;

                // Show results
                output.textContent = 'RESULTS:\n';
                if (data.result.status === 'success') {
                    const lc = data.result.load_cases[0];
                    output.textContent += `Load Case: ${lc.load_case_name}\n`;
                    output.textContent += `Mx = ${lc.Mx} kNm\n`;
                    output.textContent += `My = ${lc.My} kNm\n\n`;

                    output.textContent += 'Force Distribution:\n';
                    lc.load_distribution.forEach(f => {
                        output.textContent += `Fastener ${f.fastener_id} at (${f.position.x}, ${f.position.y}): N = ${f.forces.N} kN\n`;
                    });
                } else {
                    output.textContent += 'ERROR: ' + data.result.error_message;
                }

            } catch (error) {
                output.textContent += 'ERROR: ' + error.message + '\n' + error.stack;
            }
        }

        // Auto-load on page load
        loadPyodide();
    </script>
</body>
</html>
